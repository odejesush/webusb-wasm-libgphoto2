<!DOCTYPE html>
<style>
  img {
    margin: 10px;
  }

  h4 {
    color: red;
  }

  #container {
    max-width: 80%;
    margin: 20px auto;
  }

  #progress {
    margin: 20px 0;
    text-align: center;
  }
</style>
<center>
  <h1>WebUSB Camera Preview Demo</h1>
  <h4>Use at own risk at the moment! (Hasn't been tested properly, with cameras
    other than my own).</h4>
  <div>
    <p>Perform I/O operations in the following context:</p>
    <input type="radio" name="ioContext" id="useWindow" checked="checked">
    <label for="useWindow">Window</label>
    <input type="radio" name="ioContext" id="useWorker">
    <label for "useWorker">Worker</label>
  </div>
  <div>
    <button id="connectCamera">Connect to camera</button>
    <button id="filePreview" disabled>Display camera files</button>
    <button id="livePreview" disabled>Display live camera preview</button>
  </div>
  <div><p id="timer"></p></div>
  <div id="preview">
    <canvas id="canvas" width="500" height="500" style="display:none"></canvas>
    <div id="files" style="display:none">
      <div id="progress"></div>
      <div id="container"></div>
    </div>
  </div>
</center>
<script src="gp.js"></script>
<script src="usb-ptp.js"></script>
<script>
  'use strict';
  const timer = document.getElementById('timer');
  const canvas = document.getElementById('canvas');
  let worker;
  let offscreen;

  // These are used to time the file preview function to see the performance
  // difference between using the Window and Worker contexts.
  let startTime;
  let endTime;

  // These functions are used to update the page with data from the USB
  // device. The Dedicated Worker context contains functions with the same
  // name to allow usb-ptp.js to work in that context. The worker functions
  // postMessage to this context and the message handler below calls these
  // functions with the data from the device.
  function displayProgress(text) {
    document.getElementById('progress').textContent = text;
  }

  function createImage(blob) {
    const img = new Image();
    img.src = URL.createObjectURL(blob);
    document.getElementById('container').appendChild(img);
  }

  // Pad time to 2 digits.
  function pad(n, z) {
    z = z || 2;
    return ('00' + n).slice(-z);
  }

  function displayPerformance() {
    let delta = endTime - startTime;
    let milliseconds = delta % 1000;
    delta = (delta - milliseconds) / 1000;
    let seconds = delta % 60;
    delta = (delta - seconds) / 60;
    let minutes = delta % 60;
    timer.textContent = 'Time elapsed: ' + pad(minutes) + ':' +
        pad(seconds) + ':' + milliseconds.toString() + 'minutes';
  }

  function checkDevices() {
    // Disable the preview buttons if a camera has not been requested yet.
    navigator.usb.getDevices({ filters: getFilters() })
        .then(devices => {
          if (devices.length > 0) {
            document.getElementById('filePreview').disabled = false;
            document.getElementById('livePreview').disabled = false;
          }
        });
  }

  if (UsbPTP) {
    function workerOnMessageHandler(event) {
      switch (event.data.command) {
        case 'displayProgress':
          displayProgress(event.data.text);
          break;
        case 'createImage':
          createImage(event.data.blob);
          break;
        case 'finished':
          // endTime = event.data.endTime;
          endTime = performance.now();
          displayPerformance();
          break;
      }
    }

    document.getElementById('connectCamera')
        .addEventListener('click', async () => {
          let filters = getFilters();
          await navigator.usb.requestDevice({ filters })
              .then(() => document.getElementById('progress').textContext =
                  'Successfully connected to camera.')
              .catch(err => document.getElementById('progress').textContext =
                  err.message);
          checkDevices();
    });

    document.getElementById('filePreview')
        .addEventListener('click', async () => {
          document.getElementById('canvas').style = 'display:none';
          document.getElementById('files').style = 'display:block';
          document.getElementById('container').innerHTML = '';
          if (document.getElementById('useWorker').checked) {
            if (!worker)
              worker = new Worker('usb-worker.js');
            worker.onmessage = workerOnMessageHandler;
            startTime = performance.now();
            worker.postMessage({ command: 'fileCapture' });
            return;
          }
          startTime = performance.now();
          await fileCapture();
          endTime = performance.now();
          displayPerformance();
          return;
        });

    document.getElementById('livePreview')
        .addEventListener('click', async () => {
          document.getElementById('canvas').style = 'display:block';
          // document.getElementById('files').style = 'display:none';
          if (document.getElementById('useWorker').checked) {
            if (!offscreen)
              offscreen = canvas.transferControlToOffscreen();
            if (!worker)
              worker = new Worker('usb-worker.js');
            worker.onmessage = workerOnMessageHandler;
            worker.postMessage({ command: 'preview', canvas: offscreen },
                [offscreen]);
            return;
          }
          preview(canvas);
          return;
        });

    checkDevices();
  }
</script>
