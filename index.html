<!DOCTYPE html>
<style>
  img {
    margin: 10px;
  }

  h4 {
    color: red;
  }

  #container {
    max-width: 80%;
    margin: 20px auto;
  }

  #progress {
    margin: 20px 0;
    text-align: center;
  }
</style>
<center>
  <h1>WebUSB Camera File Preview Demo</h1>
  <h4>Use at own risk at the moment! (Hasn't been tested properly, with cameras other than my own).</h4>
  <div>
    <p>Perform I/O operations in the following context:</p>
    <input type="radio" name="ioContext" id="useWindow">
    <label for="useWindow">Window</label>
    <input type="radio" name="ioContext" id="useWorker">
    <label for "useWorker">Worker</label>
  </div>
  <div>
    <button id=button>Click button - receive previews!</button>
  </div>
</center>
<div id="progress"></div>
<div id="container"></div>
<script src="gp.js"></script>
<script src="usb-ptp.js"></script>
<script>
  'use strict';

  let worker;

  function workerOnMessageHandler(event) {
    switch (event.data.command) {
      case 'requestDevice':
        navigator.usb.requestDevice({ filters: event.data.filters })
            .then(async (device) => {
              let devices = await navigator.usb.getDevices();
              for (let i = 0; i < devices.length; ++i) {
                if (device === devices[i])
                  worker.postMessage({ command: 'getDevice', devInx: i });
              }
              worker.postMessage({
                command: 'getDevice', devInx: devices.length
              });
            }).catch(err => postMessage({ command: 'getDevice', devInx: -1 }));
        break;
      case 'displayProgress':
        displayProgress(event.data.text);
        break;
      case 'createImage':
        createImage(event.data.blob);
        break;
    }
  }

  function displayProgress(text) {
    document.getElementById('progress').textContent = text;
  }

  function createImage(blob) {
    const img = new Image();
    img.src = URL.createObjectURL(blob);
    document.getElementById('container').appendChild(img);
  }

  document.getElementById('button').addEventListener('click', async () => {
    if (document.getElementById('useWorker').checked) {
      worker = new Worker('usb-worker.js');
      worker.onmessage = workerOnMessageHandler;
      worker.postMessage('fileCapture');
      return;
    }
    fileCapture();
    return;
  });
</script>
