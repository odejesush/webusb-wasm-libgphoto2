<!DOCTYPE html>
<style>
  img {
    margin: 10px;
  }

  h4 {
    color: red;
  }

  #container {
    max-width: 80%;
    margin: 20px auto;
  }

  #progress {
    margin: 20px 0;
    text-align: center;
  }
</style>
<center>
  <h1>WebUSB Camera Preview Demo</h1>
  <h4>Use at own risk at the moment! (Hasn't been tested properly, with cameras
    other than my own).</h4>
  <div>
    <p>Perform I/O operations in the following context:</p>
    <input type="radio" name="ioContext" id="useWindow" checked="checked">
    <label for="useWindow">Window</label>
    <input type="radio" name="ioContext" id="useWorker">
    <label for "useWorker">Worker</label>
  </div>
  <div>
    <button id="connectCamera">Connect to camera</button>
    <button id="filePreview" disabled>Display camera files</button>
    <button id="livePreview" disabled>Display live camera preview</button>
  </div>
</center>
<div id="preview">
  <canvas id="canvas" width="500" height="500" style="display:none"></canvas>
  <div id="files" style="display:none">
    <div id="progress"></div>
    <div id="container"></div>
  </div>
</div>
<script src="gp.js"></script>
<script src="usb-ptp.js"></script>
<script>
  'use strict';

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let worker;

  // These functions are used to update the page with data from the USB
  // device. The Dedicated Worker context contains functions with the same
  // name to allow usb-ptp.js to work in that context. The worker functions
  // postMessage to this context and the message handler below calls these
  // functions with the data from the device.
  function displayProgress(text) {
    document.getElementById('progress').textContent = text;
  }

  function createImage(blob) {
    const img = new Image();
    img.src = URL.createObjectURL(blob);
    document.getElementById('container').appendChild(img);
  }

  function drawImage(blob) {
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width,
          (img.naturalHeight / img.naturalWidth) * canvas.height);
    };
    img.src = URL.createObjectURL(blob);
  }

  if (UsbPTP) {
    function workerOnMessageHandler(event) {
      switch (event.data.command) {
        case 'displayProgress':
          displayProgress(event.data.text);
          break;
        case 'createImage':
          createImage(event.data.blob);
          break;
        case 'drawImage':
          drawImage(event.data.blob);
          break;
      }
    }

    document.getElementById('connectCamera').addEventListener('click', () => {
      let filters = getFilters();
      navigator.usb.requestDevice({ filters })
          .then(() => document.getElementById('progress').textContext =
              'Successfully connected to camera.')
          .catch(err => document.getElementById('progress').textContext =
              err.message);
    });

    document.getElementById('filePreview')
        .addEventListener('click', async () => {
          document.getElementById('canvas').style = 'display:none';
          document.getElementById('files').style = 'display:block';
          if (document.getElementById('useWorker').checked) {
            if (!worker)
              worker = new Worker('usb-worker.js');
            worker.onmessage = workerOnMessageHandler;
            worker.postMessage({ command: 'fileCapture' });
            return;
          }
          fileCapture();
          return;
        });

    document.getElementById('livePreview')
        .addEventListener('click', async () => {
          document.getElementById('canvas').style = 'display:block';
          document.getElementById('files').style = 'display:none';
          if (document.getElementById('useWorker').checked) {
            if (!worker)
              worker = new Worker('usb-worker.js');
            worker.onmessage = workerOnMessageHandler;
            worker.postMessage({ command: 'preview' });
            return;
          }
          preview();
          return;
        });

    // Disable the preview buttons if a camera has not been requested yet.
    navigator.usb.getDevices({ filters: getFilters() })
        .then(devices => {
          if (devices.length > 0) {
            document.getElementById('filePreview').disabled = false;
            document.getElementById('livePreview').disabled = false;
          }
        });
  }
</script>
