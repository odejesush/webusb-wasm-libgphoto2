<!DOCTYPE html>
<style>
  img {
    margin: 10px;
  }

  h4 {
    color: red;
  }

  canvas {
    display: block;
    margin: 20px auto;
  }
</style>
<center>
  <h1>WebUSB Camera Live Preview Demo</h1>
  <h4>Use at own risk at the moment! (Hasn't been tested properly, with cameras other than my own).</h4>
  <div>
    <p>Perform I/O operations in the following context:</p>
    <input type="radio" name="ioContext" id="useWindow">
    <label for="useWindow">Window</label>
    <input type="radio" name="ioContext" id="useWorker">
    <label for="useWorker">Worker</label>
  </div>
  <div>
    <button id=button>Click button - receive live preview!</button>
  </div>
</center>
<canvas id="canvas" width="500" height="500"></canvas>
<script src="gp.js"></script>
<script src="usb-ptp.js"></script>
<script>
  'use strict';

  let worker;

  function workerOnMessageHandler(event) {
    switch(event.data.command) {
      case 'requestDevice':
        navigator.usb.requestDevice({ filters: event.data.filters })
            .then(async (device) => {
              let devices = await navigator.usb.getDevices();
              for (let i = 0; i < devices.length; ++i) {
                if (device === devices[i])
                  worker.postMessage({ command: 'getDevice', devInx: i });
              }
              worker.postMessage({
                command: 'getDevice', devInx: device.length
              });
            }).catch(err => postMessage({ command: 'getDevice', devInx: -1 }));
        break;
      case 'drawImage':
        drawImage(event.data.blob);
        break;
    }
  }

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  function drawImage(blob) {
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, (img.naturalHeight / img.naturalWidth) * canvas.height);
    };
    img.src = URL.createObjectURL(blob);
  }

  document.getElementById('button').addEventListener('click', async () => {
    if (document.getElementById('useWorker').checked) {
      worker = new Worker('usb-worker.js');
      worker.onmessage = workerOnMessageHandler;
      worker.postMessage('preview');
      return;
    }
    preview();
    return;
  });
</script>
